<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Himal 3D Racing</title>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#0b0b0b;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;user-select:none;}
#ui{position:absolute;left:12px;top:12px;z-index:10;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,0.8);}
#title{font-weight:700;font-size:18px;color:#ffd54f;margin-bottom:6px;}
#scoreBox{background:rgba(0,0,0,0.35);padding:6px 10px;border-radius:8px;display:inline-block;font-weight:600;}
#overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:11;background:linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));color:#fff;flex-direction:column;}
#startBtn,#restartBtn{margin-top:12px;padding:10px 18px;font-size:18px;border-radius:10px;border:0;background:#ffd54f;color:#111;cursor:pointer;box-shadow:0 6px #9a6b00;}
#hint{margin-top:8px;font-size:13px;opacity:0.9;color:#ddd;}
canvas{display:block;width:100%;height:100%;}
#touchLeft,#touchRight{position:absolute;bottom:0;width:50%;height:35%;z-index:9;}
#touchLeft{left:0;}#touchRight{right:0;}
#gameOverPanel{background:rgba(0,0,0,0.6);padding:12px 16px;border-radius:10px;text-align:center;}
</style>
</head>
<body>
<div id="ui">
  <div id="title">üèÅ Himal 3D Racing</div>
  <div id="scoreBox">Score: <span id="score">0</span></div>
</div>

<div id="overlay">
  <div style="font-size:22px;font-weight:700">Welcome to Himal 3D Racing</div>
  <div id="hint">Tap left/right (mobile) or use ‚Üê ‚Üí / A D to move</div>
  <button id="startBtn">Start Race</button>
</div>

<div id="touchLeft"></div>
<div id="touchRight"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r125/three.min.js"></script>
<script>
let scene,camera,renderer,roadGroup,player,obstacles=[];
let laneWidth=3,roadHalfWidth=6,speed=0.25,spawnInterval=90,frames=0,score=0,running=false;
let overlay=document.getElementById('overlay'),scoreEl=document.getElementById('score');
let startBtn=document.getElementById('startBtn'),touchLeft=document.getElementById('touchLeft'),touchRight=document.getElementById('touchRight');
let highKey='himal3d_highscore',highScore=parseInt(localStorage.getItem(highKey))||0;
let moveTargetX=0,lanes=[-roadHalfWidth+laneWidth,0,roadHalfWidth-laneWidth],currentLane=1;
let roadTexts=[];

function init(){
  scene=new THREE.Scene();
  scene.fog=new THREE.FogExp2(0x070707,0.02);

  camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,6,10);
  camera.lookAt(0,1.6,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const ambient=new THREE.AmbientLight(0xffffff,0.6); scene.add(ambient);
  const dir=new THREE.DirectionalLight(0xffffff,0.7); dir.position.set(5,10,5); scene.add(dir);

  makeRoad();
  makePlayer();

  window.addEventListener('resize',onResize);
  document.addEventListener('keydown',onKey);
  touchLeft.addEventListener('touchstart',()=>moveLeft());
  touchRight.addEventListener('touchstart',()=>moveRight());
  renderer.domElement.addEventListener('pointerdown',onPointer);
  startBtn.addEventListener('click',startGame);
}

function makeRoad(){
  roadGroup=new THREE.Group();
  const roadGeo=new THREE.PlaneBufferGeometry(roadHalfWidth*2+2,1000);
  const roadMat=new THREE.MeshStandardMaterial({color:0x222222});
  const road=new THREE.Mesh(roadGeo,roadMat); road.rotation.x=-Math.PI/2; road.position.z=-450; roadGroup.add(road);

  // Stripes
  const stripeGeo=new THREE.PlaneBufferGeometry(0.15,8);
  const stripeMat=new THREE.MeshBasicMaterial({color:0xffffff});
  for(let i=-200;i<200;i+=14){const s=new THREE.Mesh(stripeGeo,stripeMat); s.rotation.x=-Math.PI/2; s.position.set(0,0.01,i); roadGroup.add(s);}

  // Borders
  const borderGeo=new THREE.PlaneBufferGeometry(0.4,1000);
  const borderMat=new THREE.MeshBasicMaterial({color:0xffffff});
  const bl=new THREE.Mesh(borderGeo,borderMat); bl.rotation.x=-Math.PI/2; bl.position.set(-roadHalfWidth-0.5,0.02,-450); roadGroup.add(bl);
  const br=new THREE.Mesh(borderGeo,borderMat); br.rotation.x=-Math.PI/2; br.position.set(roadHalfWidth+0.5,0.02,-450); roadGroup.add(br);

  // Ground
  const groundGeo=new THREE.PlaneBufferGeometry(1000,1000);
  const groundMat=new THREE.MeshStandardMaterial({color:0x0b3a2e});
  const ground=new THREE.Mesh(groundGeo,groundMat); ground.rotation.x=-Math.PI/2; ground.position.y=-0.01; ground.position.z=-450; scene.add(ground);

  // "HIMAL" on left-middle and right-middle lanes
  const canvas=new OffscreenCanvas(128,32);
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='white'; ctx.font='28px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('HIMAL',64,16);
  const tex=new THREE.CanvasTexture(canvas);
  const textGeo=new THREE.PlaneBufferGeometry(2,0.5);

  for(let z=-200; z<200; z+=14){
    const textMatL=new THREE.MeshBasicMaterial({map:tex,transparent:true});
    const tL=new THREE.Mesh(textGeo,textMatL);
    tL.rotation.x=-Math.PI/2; tL.position.set(-laneWidth*0.5,0.02,z);
    roadGroup.add(tL); roadTexts.push(tL);

    const textMatR=new THREE.MeshBasicMaterial({map:tex,transparent:true});
    const tR=new THREE.Mesh(textGeo,textMatR);
    tR.rotation.x=-Math.PI/2; tR.position.set(laneWidth*0.5,0.02,z);
    roadGroup.add(tR); roadTexts.push(tR);
  }

  scene.add(roadGroup);
}

function makePlayer(){
  const g=new THREE.BoxBufferGeometry(1.1,0.6,2.2);
  const mats=[]; for(let i=0;i<6;i++){ mats.push(new THREE.MeshStandardMaterial({color:0xff3d00,metalness:0.3,roughness:0.6})); }
  player=new THREE.Mesh(g,mats); player.position.set(lanes[currentLane],0.6,6); player.castShadow=true; scene.add(player); moveTargetX=player.position.x;

  const loader=new THREE.TextureLoader();
  loader.load('car.png',function(tex){
    tex.wrapS=THREE.ClampToEdgeWrapping; tex.wrapT=THREE.ClampToEdgeWrapping;
    const topMat=new THREE.MeshStandardMaterial({map:tex,metalness:0.3,roughness:0.6});
    mats[2]=topMat; player.material=mats; player.material.needsUpdate=true;
  },undefined,function(){console.warn('car.png failed to load ‚Äî put it in same folder as index.html');});
}

function spawnObstacle(){
  const lane=Math.floor(Math.random()*3);
  const g=new THREE.BoxBufferGeometry(1.1,0.6,2.2);
  const loader=new THREE.TextureLoader();
  loader.load('Himal.jpg', function(tex){
    tex.wrapS = THREE.ClampToEdgeWrapping;
    tex.wrapT = THREE.ClampToEdgeWrapping;
    const m=new THREE.MeshStandardMaterial({map: tex, metalness:0.2, roughness:0.6});
    const car=new THREE.Mesh(g,m);
    car.position.set(lanes[lane],0.6,-120);
    car.userData={lane,speed:speed+Math.random()*0.12};
    scene.add(car); obstacles.push(car);
  }, undefined, function(){console.warn('flag.png failed to load ‚Äî put it in same folder as index.html'); });
}

function checkCollision(a,b){ const ab=new THREE.Box3().setFromObject(a); const bb=new THREE.Box3().setFromObject(b); return ab.intersectsBox(bb); }

function onKey(e){if(!running)return;if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A')moveLeft(); if(e.key==='ArrowRight'||e.key==='d'||e.key==='D')moveRight();}
function onPointer(e){if(!running)return; const x=e.clientX;if(x<window.innerWidth/2)moveLeft(); else moveRight();}
function moveLeft(){if(currentLane>0){currentLane--; moveTargetX=lanes[currentLane];}}
function moveRight(){if(currentLane<2){currentLane++; moveTargetX=lanes[currentLane];}}

function startGame(){overlay.style.display='none';score=0;frames=0;speed=0.25;spawnInterval=90;obstacles.forEach(o=>scene.remove(o));obstacles=[];currentLane=1;moveTargetX=lanes[currentLane];player.position.set(moveTargetX,0.6,6);running=true;animate();}

function endGame(){
  running=false;
  overlay.style.display='flex';
  overlay.innerHTML=`<div id="gameOverPanel">
      <div style="font-size:22px;font-weight:800;">üí• Game Over</div>
      <div style="margin-top:10px;">Your score: <strong>${score}</strong></div>
      <div style="margin-top:6px;">High score: <strong>${highScore}</strong></div>
      <button id="restartBtn">Restart</button>
    </div>`;
  const btn=document.getElementById('restartBtn'); btn.addEventListener('click',()=>{ location.reload(); });
  if(score>highScore){ highScore=score; localStorage.setItem(highKey,highScore); }
}

function animate(){
  if(!running)return;
  frames++;
  if(frames%Math.max(40,spawnInterval-Math.floor(score/6))===0){ spawnObstacle(); }

  obstacles.forEach((o,idx)=>{
    o.position.z+=(speed+(score*0.003)+o.userData.speed*0.5);
    if(o.position.z>20){ scene.remove(o); obstacles.splice(idx,1); score++; scoreEl.innerText=score; }
    if(checkCollision(player,o)){ endGame(); }
  });

  // Scroll road texts
  roadTexts.forEach(t=>{
    t.position.z+=0.8+speed;
    if(t.position.z>200) t.position.z-=400;
  });

  roadGroup.children.forEach((child)=>{
    if(child.geometry && child.geometry.parameters && child.geometry.parameters.height===1000)return;
    child.position.z+=0.8+speed;
    if(child.position.z>200)child.position.z-=400;
  });

  player.position.x+=(moveTargetX-player.position.x)*0.18;
  player.rotation.z=(moveTargetX-player.position.x)*0.15;
  camera.position.x+=(player.position.x-camera.position.x)*0.08;
  camera.position.y=6+Math.sin(frames*0.02)*0.06;

  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}

function onResize(){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }

init();
</script>
</body>
</html>
